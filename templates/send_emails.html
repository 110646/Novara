{% extends "base.html" %}

{% block content %}
<style>
  #emailSlider {
    -webkit-appearance: none;
    width: 100%;
    max-width: 600px;
    height: 8px;
    border-radius: 4px;
    background: #ddd;
    outline: none;
    transition: background 0.3s;
  }

  #emailSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    transition: background 0.3s;
  }

  #emailSlider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    transition: background 0.3s;
  }

  #emailSlider:hover {
    background: #ccc;
  }

  .slider-container {
    width: 100%;
    max-width: 600px;
    margin: 30px 0;
  }

  #portfolioModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }

  #portfolioModal .modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }

  .btn {
    padding: 10px 20px;
    margin-top: 10px;
  }
</style>

<h1>Send Emails</h1>

<form id="emailForm" method="POST">
    {% csrf_token %}

    <div class="slider-container">
        <label for="emailSlider">Number of Emails to Send:</label>
        <input type="range" id="emailSlider" name="email_count" min="10" max="300" step="1" value="50" oninput="updateSlider()">
        <p><strong>Selected:</strong> <span id="selectedCount">50</span> emails</p>
        <p><strong>Total cost:</strong> <span id="totalCost">$10.00</span></p>
    </div>

    <button type="submit" class="btn btn-primary">Pay & Send Emails</button>
</form>

<!-- Modal for portfolio check -->
<div id="portfolioModal">
  <div class="modal-content">
    <h3>Portfolio Incomplete</h3>
    <p>Please complete your portfolio before continuing.</p>
    <button onclick="document.getElementById('portfolioModal').style.display='none'" class="btn btn-secondary">OK</button>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
function updateSlider() {
    const slider = document.getElementById("emailSlider");
    const count = parseInt(slider.value);
    const cost = (count * 0.20).toFixed(2);

    document.getElementById("selectedCount").innerText = count;
    document.getElementById("totalCost").innerText = `$${cost}`;
}

document.getElementById("emailForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const emailCount = document.getElementById("emailSlider").value;
    const isComplete = "{{ portfolio_complete|yesno:'true,false' }}" === "true";

    if (!isComplete) {
        document.getElementById("portfolioModal").style.display = "flex";
        return;
    }

    const response = await fetch("{% url 'create_checkout_session' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ email_count: emailCount })
    });

    const data = await response.json();
    if (data.id) {
        const stripe = Stripe("{{ stripe_public_key }}");
        stripe.redirectToCheckout({ sessionId: data.id });
    } else {
        alert("Something went wrong. Please try again.");
    }
});

updateSlider();
</script>
{% endblock %}
