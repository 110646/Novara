{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/send_emails.css' %}">

<div class="send-emails-page">
  <div class="send-card">
    <div class="send-card-header">
      <div class="send-icon"><i class="fas fa-envelope"></i></div>
      <h1>Send Your Emails</h1>
      <p class="subtitle">Select the number of emails to send</p>
    </div>
    <form id="emailForm" method="POST" class="send-form">
      {% csrf_token %}
      <div class="slider-label-row">
        <label for="emailSlider">Number of Emails</label>
        <span class="slider-value-badge" id="sliderValue">10</span>
      </div>
      <div class="slider-row">
        <span class="slider-min">10</span>
        <input
          type="range"
          id="emailSlider"
          name="email_count"
          min="10"
          max="300"
          step="1"
          value="10"
          oninput="updateSlider()"
        />
        <span class="slider-max">300</span>
      </div>
      <div class="price-box">
        <div class="price-row">Price: $0.20 per email</div>
        <div class="total-row">Total: <span class="total-amount" id="totalCost">$2.00</span></div>
      </div>
      <button type="submit" class="btn btn-primary send-btn"><i class="fas fa-paper-plane"></i> Send Emails</button>
    </form>
  </div>
</div>

<!-- Modal for incomplete portfolio -->
<div id="portfolioModal" class="modal">
  <div class="modal-content">
    <h3>Portfolio Incomplete</h3>
    <p>Please complete your portfolio before continuing.</p>
    <button onclick="document.getElementById('portfolioModal').style.display='none'" class="btn btn-secondary">OK</button>
  </div>
</div>

<!-- Modal for portfolio confirmation -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Confirm Your Portfolio</h3>
    <p>Please double-check your portfolio before continuing. This information will be sent to professors.</p>
    <div style="margin-top: 20px;">
      <button onclick="closeConfirmModal()" class="btn btn-secondary">Go Back</button>
      <button onclick="proceedWithCheckout()" class="btn btn-primary">Continue</button>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  function updateSlider() {
    const slider = document.getElementById("emailSlider");
    const count = parseInt(slider.value);
    const cost = (count * 0.20).toFixed(2);
    document.getElementById("sliderValue").innerText = count;
    document.getElementById("totalCost").innerText = `$${cost}`;
  }

  document.getElementById("emailForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const isComplete = "{{ portfolio_complete|yesno:'true,false' }}" === "true";

    if (!isComplete) {
      document.getElementById("portfolioModal").style.display = "flex";
      return;
    }

    // Show confirmation modal
    document.getElementById("confirmModal").style.display = "flex";
  });

  function closeConfirmModal() {
    document.getElementById("confirmModal").style.display = "none";
  }

  async function proceedWithCheckout() {
    closeConfirmModal();

    const emailCount = document.getElementById("emailSlider").value;

    const response = await fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ email_count: emailCount }),
    });

    const data = await response.json();
    if (data.id) {
      const stripe = Stripe("{{ stripe_public_key }}");
      stripe.redirectToCheckout({ sessionId: data.id });
    } else {
      alert("Something went wrong. Please try again.");
    }
  }

  updateSlider();
</script>
{% endblock %}
