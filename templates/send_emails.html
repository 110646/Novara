{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/send_emails.css' %}">

<h1>Send Emails</h1>

<form id="emailForm" method="POST">
  {% csrf_token %}

  <div class="slider-container">
    <label for="emailSlider">Number of Emails to Send:</label>
    <input
      type="range"
      id="emailSlider"
      name="email_count"
      min="10"
      max="300"
      step="1"
      value="50"
      oninput="updateSlider()"
    />
    <p><strong>Selected:</strong> <span id="selectedCount">50</span> emails</p>
    <p><strong>Total cost:</strong> <span id="totalCost">$10.00</span></p>
  </div>

  <button type="submit" class="btn btn-primary">Pay & Send Emails</button>
</form>

<!-- Modal for incomplete portfolio -->
<div id="portfolioModal" class="modal">
  <div class="modal-content">
    <h3>Portfolio Incomplete</h3>
    <p>Please complete your portfolio before continuing.</p>
    <button onclick="document.getElementById('portfolioModal').style.display='none'" class="btn btn-secondary">OK</button>
  </div>
</div>

<!-- Modal for portfolio confirmation -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Confirm Your Portfolio</h3>
    <p>Please double-check your portfolio before continuing. This information will be sent to professors.</p>
    <div style="margin-top: 20px;">
      <button onclick="closeConfirmModal()" class="btn btn-secondary">Go Back</button>
      <button onclick="proceedWithCheckout()" class="btn btn-primary">Continue</button>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  function updateSlider() {
    const slider = document.getElementById("emailSlider");
    const count = parseInt(slider.value);
    const cost = (count * 0.20).toFixed(2);
    document.getElementById("selectedCount").innerText = count;
    document.getElementById("totalCost").innerText = `$${cost}`;
  }

  document.getElementById("emailForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const isComplete = "{{ portfolio_complete|yesno:'true,false' }}" === "true";

    if (!isComplete) {
      document.getElementById("portfolioModal").style.display = "flex";
      return;
    }

    // Show confirmation modal
    document.getElementById("confirmModal").style.display = "flex";
  });

  function closeConfirmModal() {
    document.getElementById("confirmModal").style.display = "none";
  }

  async function proceedWithCheckout() {
    closeConfirmModal();

    const emailCount = document.getElementById("emailSlider").value;

    const response = await fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ email_count: emailCount }),
    });

    const data = await response.json();
    if (data.id) {
      const stripe = Stripe("{{ stripe_public_key }}");
      stripe.redirectToCheckout({ sessionId: data.id });
    } else {
      alert("Something went wrong. Please try again.");
    }
  }

  updateSlider();
</script>
{% endblock %}
