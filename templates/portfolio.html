{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/portfolio.css' %}">

<div class="portfolio-page">
  <div class="portfolio-main">
    <div class="card profile-card">
      <div class="card-header">
        <h1>Build Your Research Profile</h1>
        <p class="subtitle">Create an impressive profile that professors will notice.</p>
      </div>
      <div class="card-body">
        {% if not editing %}
        <a href="?edit=1" class="btn btn-secondary edit-btn" style="text-decoration: none;">Edit Portfolio</a>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="form-group">
            <label for="id_name">Name <span class="required">*</span></label>
            <input type="text" name="name" id="id_name" value="{{ portfolio.name|default_if_none:'' }}" {% if not editing %}disabled{% endif %} required />
          </div>

          <div class="form-group">
            <label for="id_class_year">Academic Level <span class="required">*</span></label>
            <select name="class_year" id="id_class_year" {% if not editing %}disabled{% endif %} required>
              <option value="">Select Academic Level</option>
              {% for val, label in class_year_choices %}
              <option value="{{ val }}" {% if portfolio.class_year == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="id_university">University <span class="required">*</span></label>
            <select name="university" id="id_university" {% if not editing %}disabled{% endif %} required>
              <option value="">Select University</option>
              {% for val, label in university_choices %}
              <option value="{{ val }}" {% if portfolio.university == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="id_major">Major <span class="required">*</span></label>
            <select name="major" id="id_major" {% if not editing %}disabled{% endif %} required>
              <option value="">Select Major</option>
              {% for val, label in major_choices %}
              <option value="{{ val }}" {% if portfolio.major == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="id_research_interests">Research Interests <span class="required">*</span></label>
            <input type="text" name="research_interests" id="id_research_interests"
                   value="{{ portfolio.research_interests|default_if_none:'' }}"
                   placeholder="e.g., Machine Learning, Computer Vision, AI"
                   {% if not editing %}disabled{% endif %} required />
            <div class="form-hint">e.g., Machine Learning, Computer Vision, AI</div>
          </div>

          <div class="form-group">
            <label for="id_resume">Resume (PDF)</label>
            {% if portfolio.resume_url %}
              <div class="resume-display">
                <span class="form-hint">Uploaded Resume:</span>
                <a href="{{ portfolio.resume_url }}" target="_blank">{{ resume_filename }}</a>
                {% if editing %}
                <button type="submit" name="delete_resume" value="1" class="btn btn-danger btn-sm ml-2">Delete</button>
                {% endif %}
              </div>
            {% else %}
              <p class="form-hint">No resume uploaded yet.</p>
            {% endif %}
            <input type="file" name="resume" id="id_resume" {% if not editing %}disabled{% endif %} />
          </div>

          {% if editing %}
          <button type="submit" class="btn btn-primary save-btn">Save Profile</button>
          {% endif %}
        </form>
      </div>
    </div>

    {% if portfolio and not editing %}
    <div class="card info-card">
      <div class="card-header">
        <h2>Current Portfolio Information</h2>
        <div class="last-updated">Last Updated: {{ portfolio.updated_at }}</div>
      </div>
      <div class="card-body">
        <ul class="info-list">
          <li><strong>Name:</strong> {{ portfolio.name }}</li>
          <li><strong>Major:</strong> {{ portfolio.major }}</li>
          <li><strong>Academic Level:</strong> {{ portfolio.class_year }}</li>
          <li><strong>University:</strong> {{ portfolio.university }}</li>
          <li><strong>Research Interests:</strong> {{ portfolio.research_interests }}</li>
        </ul>
      </div>
    </div>
    {% endif %}

    <div class="card action-card">
      <div class="card-body">
        <h3>Done Building Your Portfolio?</h3>
        <a href="{% url 'send_emails' %}" class="btn btn-primary action-btn">Buy and Send Emails</a>
      </div>
    </div>
  </div>

  <div class="portfolio-sidebar">
    <div class="card professor-view-card">
      <div class="card-header">
        <span class="professor-icon"><i class="fas fa-user-graduate"></i></span>
        <span class="professor-title">Professor View</span>
        <div class="professor-subtitle">How your profile appears to professors</div>
      </div>
      <div class="card-body">
        <div class="professor-avatar">
          <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile Photo" />
        </div>
        <div class="professor-name">{{ portfolio.name|default:user.get_full_name|default:user.email }}</div>
        <div class="professor-university">{{ portfolio.university|default:'University' }}</div>
        <div class="professor-major"><span>Major</span><br><strong>{{ portfolio.major|default:'Major' }}</strong></div>
        <div class="professor-interests"><span>Research Interests</span><br><span class="interests-list">{{ portfolio.research_interests|default:'Add interests...' }}</span></div>
      </div>
    </div>

    <div class="card profile-strength-card">
      <div class="card-header">
        <span class="strength-icon"><i class="fas fa-bolt"></i></span>
        <span class="strength-title">Profile Completion</span>
      </div>
      <div class="card-body">
        <div class="strength-bar-bg">
          <div id="strengthBarFill" class="strength-bar-fill" style="width: 0%;"></div>
        </div>
        <div id="strengthLabel" class="strength-label">Getting Started</div>
      </div>
    </div>
  </div>
</div>

<script>
  function calculateStrength() {
    let filled = 0;
    const total = 6;

    if (document.getElementById("id_name").value.trim()) filled++;
    if (document.getElementById("id_class_year").value.trim()) filled++;
    if (document.getElementById("id_university").value.trim()) filled++;
    if (document.getElementById("id_major").value.trim()) filled++;
    if (document.getElementById("id_research_interests").value.trim()) filled++;

    const resumeInput = document.getElementById("id_resume");
    const resumeUploaded = document.querySelector(".resume-display a");
    if (resumeInput.files.length > 0 || resumeUploaded) filled++;

    const percent = Math.round((filled / total) * 100);
    const bar = document.getElementById("strengthBarFill");
    bar.style.width = percent + "%";
    bar.classList.toggle("complete", percent === 100);


    let label = "Getting Started";
    if (percent >= 100) label = "Done!";
    else if (percent >= 70) label = "Almost There";
    else if (percent >= 40) label = "In Progress";
    document.getElementById("strengthLabel").innerText = label;
  }


  calculateStrength();

  ["id_name", "id_class_year", "id_university", "id_major", "id_research_interests", "id_resume"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", calculateStrength);
      el.addEventListener("change", calculateStrength); 
    }
  });
</script>

{% endblock %}
